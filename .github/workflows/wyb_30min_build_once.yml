name: Check Push Time

on:
  push:
    branches:
      - main

jobs:
  check_push_time:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Get Last Two Commit Timestamps
      id: last_two_commits
      run: |
        # COMMITS=$(curl -s -H "Authorization: Bearer ${{ secrets.ACTION_NETLIFYDIGITALGARDEN_30MIN_PER_BUILD }}" \
        #   "https://api.github.com/repos/${{ github.repository }}/commits?per_page=2")
        # LATEST_COMMIT_TIME=$(echo "$COMMITS" | jq -r '.[0].commit.author.date' | xargs -I{} date -d {} +%s)
        # PREVIOUS_COMMIT_TIME=$(echo "$COMMITS" | jq -r '.[1].commit.author.date' | xargs -I{} date -d {} +%s)
        # # echo "::set-output name=latest_commit_timestamp::$LATEST_COMMIT_TIME"
        # # echo "::set-output name=previous_commit_timestamp::$PREVIOUS_COMMIT_TIME"
        # echo "latest_commit_timestamp=$LATEST_COMMIT_TIME" >> $GITHUB_OUTPUT
        # echo "previous_commit_timestamp=$PREVIOUS_COMMIT_TIME" >> $GITHUB_OUTPUT
        
        # 当前commit的SHA
        CURRENT_SHA=$GITHUB_SHA
        echo "The commit SHA is: $GITHUB_SHA"
        
        # PREVIOUS_SHA=$(git rev-parse "$CURRENT_SHA~1")
        # PREVIOUS_SHA=$(git rev-parse "$CURRENT_SHA^")
        # echo "Previous commit SHA: $PREVIOUS_SHA"

        # 获取至少20个 commit 的历史
        # COMMIT_HISTORY=$(git log --pretty=format:'%H %ai' --reverse -n 20)
        COMMIT_HISTORY=$(git log --pretty=format:'%H' --reverse -n 5)
        echo "commit history: $COMMIT_HISTORY"

        # 找到当前 commit 的索引
        # COMMIT_INDEX=$(echo "$COMMIT_HISTORY" | grep " $CURRENT_SHA " | cut -d' ' -f1)
        COMMIT_INDEX=$(echo "$COMMIT_HISTORY" | grep "$CURRENT_SHA" | cut -d: -f1)
        echo "commit index: $COMMIT_INDEX"

        # 如果找到当前 commit，获取前一个 commit 的 SHA
        if [ "$COMMIT_INDEX" != "" ]; then
          PREVIOUS_COMMIT_INDEX=$(($COMMIT_INDEX - 1))
          PREVIOUS_SHA=$(echo "$COMMIT_HISTORY" | cut -d' ' -f$PREVIOUS_COMMIT_INDEX)
          echo "Previous commit SHA: $PREVIOUS_SHA"
        else
          echo "Current commit not found in the last 20 commits."
        fi
        

    - name: Check Push Time
      run: |
        # LATEST_COMMIT_TIME=${{ steps.last_two_commits.outputs.latest_commit_timestamp }}
        # PREVIOUS_COMMIT_TIME=${{ steps.last_two_commits.outputs.previous_commit_timestamp }}
        # ELAPSED_TIME=$((LATEST_COMMIT_TIME - PREVIOUS_COMMIT_TIME))
        # echo "Elapsed time since last commit: $ELAPSED_TIME seconds"
        # if [ $ELAPSED_TIME -gt 1800 ]; then
        #   echo "Time elapsed is greater than 30 minutes. Performing action..."
        #   curl -X POST -d '{}' https://api.netlify.com/build_hooks/65a77015df78f3742a8265b4
        # else
        #   echo "Time elapsed is within 30 minutes. Skipping action."
        # fi
